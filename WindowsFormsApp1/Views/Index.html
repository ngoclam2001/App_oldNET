<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Đất Đai</title>
    <!-- Thêm thư viện jQuery từ CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
    @page {
        size: 7in 9.25in;
        margin: 27mm 16mm 27mm 16mm;
    }

    body, ol, ul, li, th, tr, tbody, table, p, h1, h2, h3, h4, h5, h6 {
        margin: 0 auto;
    }

    th, td {
        text-align: center;
        border: 1px solid black;
    }

    table {
        border-spacing: 0;
        margin: unset;
        width: 100%;
    }

    body {
        height: 842px;
        width: 595px;
        background: white;
        font-family: Arial, Helvetica, sans-serif;
    }

    .container {
        width: 100%;
        height: auto;
    }

    .text_uppercase {
        text-transform: uppercase;
    }

    .top_info {
        display: flex;
        justify-content: space-between;
        padding: 10px;
    }

    .img_top {
        display: flex;
        justify-content: center;
        align-items: center;
    }

        .img_top img {
            width: 60px;
        }

    .text_top {
        font-size: 12px;
        margin: 0;
    }

    .text_center {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
    }

    .text_right {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .content {
        max-width: 850px;
        margin: 0 auto;
        padding: 0 16px;
    }

    .text_bold {
        font-weight: bold;
    }

    .list_person {
        display: flex;
        flex-direction: column;
    }

    .first_land_info {
        display: flex;
        justify-content: space-between;
    }

        .first_land_info p {
            margin-left: 0;
            margin-right: 0;
            margin-top: 2px;
            margin-bottom: 2px;
        }

    .image_land img {
        max-width: 100%;
    }

    li {
        margin-bottom: 4px;
        ;
    }

        li:not(:first-child) {
            margin-top: 4px;
        }

    p, span {
        margin-top: 4px;
        margin-bottom: 4px;
    }

    th {
        font-weight: normal;
    }

    .fs-10, li, span, p {
        font-size: 10px;
    }

    .hide {
        display: none;
    }

    .list_info {
        padding-left: 16px;
    }

    .btn_docx {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 24px;
    }

    #downloadBtn {
        background-color: aquamarine;
        cursor: pointer;
    }
        .no-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }

    @media print {
        .no-print, .no-print * {
            display: none !important;
        }

        html, body {
            width: 100%;
            height: auto;
            font-size: 10px;
        }

        @page {
            size: 7in 9.25in;
            margin: 27mm 16mm 27mm 16mm;
        }

    }

    </style>
</head>
<body>
    <div class="container" id="main_content">
        <div class="top_info">
            <div class="img_top">
                <img src="https://i.imgur.com/wXKCgCj.jpeg" alt="logo" crossorigin="anonymous">
            </div>
            <div class="text_center">
                <h1 class="text_top text_uppercase">thông tin quyền sử dụng đất,</h1>
                <h1 class="text_uppercase text_top">quyền sở hữu tài sản liên quan với đất</h1>
                <span class="fs-10">(Thông tin này được lấy từ mã QR in trên Giấy xác nhận)</span>
            </div>
            <div class="text_right fs-10 code_pdf">
                
            </div>
        </div>
        <div class="content">
            <ol class="list_info">
                <li class="text_bold fs-10">
                    Người sử dụng đất, chủ sử dụng tài sản gắn liền với đất:
                </li>
                <div class="list_person">
                </div>
                <li class="text_bold">
                    Thông tin thửa đất:
                </li>
                <!-- TH1: Giay chung nhan cap cho mot thua dat -->
                <div class="list_land land_first_case">
                </div>
                <!-- TH2: Giay chung nhan cho nhieu thua dat nong nghiep -->
                <div class="list_land land_second_case">
                    <div class="first_land_info">
                        <p>a. Thừa đất số: <span class="land_number_total"></span></p>
                        <p>b. Diện tích: <span class="land_area_total"></span> m2</p>
                    </div>
                    <p>c. Địa chỉ: <span class="land_address_all"></span></p>
                    <p>d. Danh sách các thửa đất:</p>
                    <table class="table_land">
                        <tbody class="list_land_append">
                            <tr>
                                <th><p>Tờ bản đồ số</p></th>
                                <th><p>Thửa đất số</p></th>
                                <th><p>Diện tích(m2)</p></th>
                                <th><p>Loại đất</p></th>
                                <th><p>Thời hạn sử dụng</p></th>
                                <th><p>Hình thức sử dụng</p> </th>
                                <th><p>Nguồn gốc sử dụng đất</p> </th>
                                <th><p>Địa chỉ</p> </th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <li class="text_bold check_asset">
                    Thông tin tài sản gắn liền với đất:
                </li>
                <!-- Cac thong tin lien qan -->
                <div class="land_info_asset">
                    
                </div>
                <!-- TH1: Giay chung nhan can ho hoac cong trinh -->
                <div class="first_case_asset">
                    <table class="table_asset_first">
                        <tbody id="table_asset_first">
                            <tr>
                                <th>
                                    <p>Tên tài sản</p>
                                </th>
                                <th>
                                    <p>Diện tích xây dựng(m2)</p>
                                </th>
                                <th>
                                    <p>Diện tích sử dụng(m2)</p>
                                </th>
                                <th>
                                    <p>Hình thức sở hữu</p>
                                </th>
                                <th>
                                    <p>Cấp công trình</p>
                                </th>
                                <th>
                                    <p>Thời hạn sở hữu</p>
                                </th>
                            </tr>

                        </tbody>
                    </table>
                </div>
                <!--TH2: Giay chung nhan can ho -->
                <div class="second_case_asset">
                    <table class="table_asset_second">
                        <tbody id="table_asset_second">
                            <tr>
                                <th>
                                    <p>Tên tài sản</p>
                                </th>
                                <th>
                                    <p>Diện tích sàn xây dựng(m2)</p>
                                </th>
                                <th>
                                    <p>Diện tích sử dụng(m2)</p>
                                </th>
                                <th>
                                    <p>Hình thức sở hữu</p>
                                </th>
                                <th>
                                    <p>Thời hạn sở hữu</p>
                                </th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="no-break">
                <li class="text_bold">
                    Sơ đồ thửa đất, tài sản gắn liền với đất:
                </li>
                <div class="image_land_list image_land"><img id="image_land" src="" alt="" crossorigin="anonymous"></div>
        </div>

        </ol>
    </div>
    </div>
    <div class="btn_docx" style="margin-top: 16px">
        <!-- <button id="downloadBtn">Tạo và tải xuống DOC</button> -->
        <button class="btn_print">Tạo và tải xuống PDF</button>
    </div>

    <script>
        $(document).ready(function () {
            window.chrome.webview.addEventListener('message', function (event) {
                const data = event.data;
                $('.code_pdf').text(data.Id);

                if (data.Muc1) {

                    const personList = [];

                    for (const key in data.Muc1) {
                        const person = data.Muc1[key];
                        personList.push({
                            name: person.PersonName,
                            cccd: person.PersonCCCD,
                            qt: person.PersonQT,
                            fname: person.PersonFName
                        });
                    }

                    console.log(personList);

                    personList.forEach(function (person) {
                        var text_person = '<div class="person" style="font-size: 10px"><span class="person_name">' + person.name + '</span>,<span class="person_cccd">' + person.cccd + '</span></div>';

                        $('.list_person').append(text_person);
                    });
                }

                if (data.Muc2) {
                    const muc2_List = [];

                    for (const key in data.Muc2) {
                        const land = data.Muc2[key];
                        muc2_List.push({
                            LandNumber: land.LandNumber,
                            LandMapNumber: land.LandMapNumber,
                            LandArea: parseFloat(land.LandArea),
                            LandClass: land.LandClass,
                            LandUseDate: land.LandUseDate,
                            LandUse: land.LandUse,
                            LandAddress: land.LandAddress,
                            LandPurpose: land.LandPurpose,
                        });
                    }
                    
                    const muc2_List_Count = muc2_List.length;

                    if (muc2_List_Count <= 1) {
                        $('.land_first_case').show();
                        $('.land_second_case').hide();
                        console.log(muc2_List);

                        muc2_List.forEach(function (land) {
                            var text_land = '<div class="first_land_info"><p>a. Thừa đất số: <span class="land_number">' + land.LandNumber + '</span></p><p>tờ bản đồ số: <span class="land_map_number">' + land.LandMapNumber + '</span></p></div><div class="first_land_info"><p>b. Diện tích: <span class="land_area">' + land.LandArea + '</span> m2</p><p>c. Loại đất: <span class="land_class">' + land.LandClass + '</span></p></div><p>d. Thời hạn sử dụng: <span class="land_use-date">' + land.LandUseDate + '</span></p><p>đ. Hình thức sử dụng: <span class="land_use">' + land.LandUse + '</span></p><p>e. Địa chỉ: <span class="land_address">' + land.LandAddress + '</span></p><p>g. Nguồn gốc sử dụng đất: <span class="land_purpose">' + land.LandPurpose + '</span></p>';

                            $('.land_first_case').append(text_land);
                        });
                    } else {
                        $('.land_first_case').hide();
                        $('.land_second_case').show();
                        $('.land_number_total').text(muc2_List.length);
                        $('.land_address_all').text(muc2_List[0].LandAddress);
                        $('.land_area_total').text(Number(muc2_List.reduce((sum, land) => sum + land.LandArea, 0).toFixed(2)));

                        muc2_List.forEach(function (land) {
                            var text_land = '<tr><td><p>' + land.LandNumber + '</p></td><td><p>' + land.LandMapNumber + '</p></td><td><p>' + land.LandArea + '</p></td><td><p>' + land.LandClass + '</p></td><td><p>' + land.LandUseDate + '</p></td><td><p>' + land.LandUse + '</p></td><td><p>' + land.LandPurpose + '</p></td><td><p>' + land.LandAddress + '</p></td></tr>';

                            $('.list_land_append').append(text_land);
                        });
                    }
                }

                if (data.Muc3) {
                    const muc3_List = [];

                    for (const key in data.Muc3) {
                        const asset = data.Muc3[key];
                        muc3_List.push({
                            AssetName: asset.AssetName,
                            AssetArea: parseFloat(asset.AssetArea),
                            AssetAreaUse: parseFloat(asset.AssetAreaUse),
                            AssetNumberFloor: asset.AssetNumberFloor,
                            AssetLevel: asset.AssetLevel,
                            AssetStructure: asset.AssetLevel,
                            AssetUse: asset.AssetUse,
                            AssetUseTime: asset.AssetUseTime,
                            AssetAddress: asset.AssetAddress,
                        });
                    }
                    
                    if (muc3_List[0].AssetName == "Không xác định") {
                        $('.check_asset').hide();
                        $('.first_case_asset').hide();
                        $('.second_case_asset').hide();
                        $('.land_info_asset').hide();
                    } else {
                        

                        if (data.IsCheckMuc3 == true) {
                            var all_area = Number(muc3_List.slice(1).reduce((sum, asset) => sum + asset.AssetArea, 0).toFixed(2));
                            var all_area_use = Number(muc3_List.slice(1).reduce((sum, asset) => sum + asset.AssetAreaUse, 0).toFixed(2));

                            $('.first_case_asset').show();
                            $('.second_case_asset').hide();
                            if (muc3_List.length > 1) {
                                var text_asset = '<div class="first_land_info"><p>a. Tên tài sản: <span class="asset_name">' + muc3_List[0].AssetName + '</span></p><p>b. Diện tích xây dựng: <span class="asset_area">' + all_area + '</span> m2</p></div><div class="first_land_info"><p>c. Diện tích sử dụng: <span class="asset_use">' + all_area_use + '</span> m2</p><p>d. Số tầng: <span class="asset_floor">' + muc3_List[2].AssetNumberFloor + '</span></p></div><div class="first_land_info"><p>đ. Kết cấu: <span class="asset_structure">' + muc3_List[2].AssetStructure + '</span></p><p>e. Cấp công trình: <span class="asset_level">' + muc3_List[2].AssetLevel + '</span></p></div><div class="first_land_info"><p>g. Hình thức sử dụng: <span class="asset_use">' + muc3_List[2].AssetUse + '</span></p><p>h. Thời hạn sử dụng: <span class="asset_date">' + muc3_List[2].AssetUseTime + '</span></p></div><p>i. Địa chỉ: <span class="asset_address">' + muc3_List[0].AssetAddress + '</span></p>';
                                $('.land_info_asset').append(text_asset);
                                muc3_List.slice(1).forEach(function (asset) {
                                    var text_asset_1 = '<tr><td><p>' + asset.AssetName + '</p></td><td><p>' + asset.AssetArea + '</p></td><td><p>' + asset.AssetAreaUse + '</p></td><td><p>' + asset.AssetUse + '</p></td><td><p>' + asset.AssetLevel + '</p></td><td><p>' + asset.AssetUseTime + '</p></td></tr>';

                                    $('#table_asset_first').append(text_asset_1);
                                });
                            } else {
                                var text_asset = '<div class="first_land_info"><p>a. Tên tài sản: <span class="asset_name">' + muc3_List[0].AssetName + '</span></p><p>b. Diện tích xây dựng: <span class="asset_area">' + muc3_List[0].AssetArea + '</span> m2</p></div><div class="first_land_info"><p>c. Diện tích sử dụng: <span class="asset_use">' + muc3_List[0].AssetAreaUse + '</span> m2</p><p>d. Số tầng: <span class="asset_floor">' + muc3_List[0].AssetNumberFloor + '</span></p></div><div class="first_land_info"><p>đ. Kết cấu: <span class="asset_structure">' + muc3_List[0].AssetStructure + '</span></p><p>e. Cấp công trình: <span class="asset_level">' + muc3_List[0].AssetLevel + '</span></p></div><div class="first_land_info"><p>g. Hình thức sử dụng: <span class="asset_use">' + muc3_List[0].AssetUse + '</span></p><p>h. Thời hạn sử dụng: <span class="asset_date">' + muc3_List[0].AssetUseTime + '</span></p></div><p>i. Địa chỉ: <span class="asset_address">' + muc3_List[0].AssetAddress + '</span></p>';
                                $('.land_info_asset').append(text_asset);
                                $('#table_asset_first').hide();
                            }
                            
                        } 
                        else {
                            $('.first_case_asset').hide();
                            $('.second_case_asset').show();
                            if (muc3_List.length > 1) {
                                var text_asset = '<div class="first_land_info"><p>a. Tên tài sản: <span class="asset_name">' + muc3_List[0].AssetName + '</span></p><p>b. Diện tích xây dựng: <span class="asset_area">' + muc3_List[1].AssetArea + '</span> m2</p></div><div class="first_land_info"><p>c. Diện tích sử dụng: <span class="asset_use">' + muc3_List[1].AssetAreaUse + '</span> m2</p><p>d. Số tầng: <span class="asset_floor">' + muc3_List[0].AssetNumberFloor + '</span></p></div><div class="first_land_info"><p>đ. Kết cấu: <span class="asset_structure">' + muc3_List[0].AssetStructure + '</span></p><p>e. Cấp công trình: <span class="asset_level">' + muc3_List[0].AssetLevel + '</span></p></div><div class="first_land_info"><p>g. Hình thức sử dụng: <span class="asset_use">' + muc3_List[0].AssetUse + '</span></p><p>h. Thời hạn sử dụng: <span class="asset_date">' + muc3_List[0].AssetUseTime + '</span></p></div><p>i. Địa chỉ: <span class="asset_address">' + muc3_List[0].AssetAddress + '</span></p>';
                                $('.land_info_asset').append(text_asset);
                                muc3_List.slice(1).forEach(function (asset) {
                                    var text_asset_2 = '<tr><td><p>' + asset.AssetName + '</p></td><td><p>' + asset.AssetArea + '</p></td><td><p>' + asset.AssetAreaUse + '</p></td><td><p>' + asset.AssetUse + '</p></td><td><p>' + muc3_List[1].AssetUseTime + '</p></td></tr>';

                                    $('#table_asset_second').append(text_asset_2);
                                });
                            } else {
                                var text_asset = '<div class="first_land_info"><p>a. Tên tài sản: <span class="asset_name">' + muc3_List[0].AssetName + '</span></p><p>b. Diện tích xây dựng: <span class="asset_area">' + muc3_List[0].AssetArea + '</span> m2</p></div><div class="first_land_info"><p>c. Diện tích sử dụng: <span class="asset_use">' + muc3_List[0].AssetAreaUse + '</span> m2</p><p>d. Số tầng: <span class="asset_floor">' + muc3_List[0].AssetNumberFloor + '</span></p></div><div class="first_land_info"><p>đ. Kết cấu: <span class="asset_structure">' + muc3_List[0].AssetStructure + '</span></p><p>e. Cấp công trình: <span class="asset_level">' + muc3_List[0].AssetLevel + '</span></p></div><div class="first_land_info"><p>g. Hình thức sử dụng: <span class="asset_use">' + muc3_List[0].AssetUse + '</span></p><p>h. Thời hạn sử dụng: <span class="asset_date">' + muc3_List[0].AssetUseTime + '</span></p></div><p>i. Địa chỉ: <span class="asset_address">' + muc3_List[0].AssetAddress + '</span></p>';
                                $('#table_asset_second').hide();
                                $('.land_info_asset').append(text_asset);
                            }
                        }
                    }
                }

                if (data.Muc4) {
                    const img_List = [];

                    for (const key in data.Muc4) {
                        const img = data.Muc4[key];
                        img_List.push({
                            img_src: img,
                        });
                    }
                    img_List.forEach(function (img) {
                        var text_img = '<img id="image_land" src="' + img.img_src + '" alt="" crossorigin="anonymous">';

                        $('.image_land_list').append(text_img);
                    });
                }
            });
        });
    </script>



    <script>              
        $(document).ready(function () {
            $(document).on("click", ".btn_print", function (event) {
                event.preventDefault();

                var element = $("#main_content")[0]; // Lấy phần tử DOM từ jQuery object

                var opt = {
                    margin: [27, 16, 27, 16],
                    filename: "mau_giay.pdf",
                    image: { type: "jpg", quality: 0.98 },
                    pagebreak: { avoid: "tr", mode: "css" },
                    html2canvas: { scale: 1, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: "mm", format: "a4", orientation: "portrait", imageTimeout: 3000 }
                };

                // Chờ tải tất cả hình ảnh trước khi xuất PDF
                const images = $("#main_content img").toArray();
                const imagesLoaded = images.map(img => {
                    return img.complete ? Promise.resolve() : new Promise(resolve => {
                        $(img).on("load error", resolve);
                    });
                });

                Promise.all(imagesLoaded).then(() => {
                    html2pdf().set(opt).from(element).save();
                });
            });
        });

    </script>
</body>
</html>

